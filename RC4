import math

# حجم صندوق الحالة (256 بايت)
N = 256

def rc4_key_scheduling_algorithm(key):
    """
    KSA: خوارزمية جدولة المفاتيح لـ RC4
    تهيئة صندوق الحالة S بناءً على مفتاح الإدخال.
    """
    S = list(range(N))
    key_length = len(key)
    j = 0
    
    # تحويل المفتاح إلى قائمة من قيم البايت (إذا لم يكن كذلك بالفعل)
    key_bytes = [ord(c) for c in key] if isinstance(key, str) else key
    
    for i in range(N):
        # j = (j + S[i] + key_bytes[i mod key_length]) mod N
        j = (j + S[i] + key_bytes[i % key_length]) % N
        
        # تبديل S[i] و S[j]
        S[i], S[j] = S[j], S[i]
        
    return S

def rc4_pseudo_random_generation_algorithm(S, output_length):
    """
    PRGA: خوارزمية توليد الأرقام شبه العشوائية.
    توليد سلسلة المفتاح (Keystream).
    """
    i = 0
    j = 0
    keystream = []
    
    for _ in range(output_length):
        i = (i + 1) % N
        j = (j + S[i]) % N
        
        # تبديل S[i] و S[j]
        S[i], S[j] = S[j], S[i]
        
        # توليد بايت Keystream
        t = (S[i] + S[j]) % N
        keystream_byte = S[t]
        keystream.append(keystream_byte)
        
    return keystream

def binary_derivative_test(keystream_bytes):
    """
    يطبق اختبار المشتق الثنائي.
    """
    # تحويل سلسلة المفتاح (بايتات) إلى سلسلة من البتات
    binary_stream = ""
    for byte in keystream_bytes:
        # تحويل كل بايت إلى 8 بتات
        binary_stream += bin(byte)[2:].zfill(8)
    
    stream_length = len(binary_stream)
    
    # حساب المشتق الثنائي (Y_i = X_i XOR X_{i-1})
    derivative_stream = ""
    for i in range(1, stream_length):
        # XOR بين البت الحالي والسابق
        derivative_bit = str(int(binary_stream[i]) ^ int(binary_stream[i-1]))
        derivative_stream += derivative_bit
        
    derivative_length = len(derivative_stream)
    
    # تطبيق اختبار التكرار (Frequency Test) على المشتق الثنائي
    zeros_count = derivative_stream.count('0')
    ones_count = derivative_length - zeros_count
    
  
    
    if derivative_length == 0:
        return "Not applicable (Stream too short)"
        
    chi_squared_statistic = (zeros_count - ones_count)**2 / derivative_length
    
    # القيمة الحرجة لـ Chi-Squared بدرجة حرية 1 عند مستوى 0.05 هي 3.841
    critical_value = 3.841
    
    result = {
        "derivative_length": derivative_length,
        "zeros": zeros_count,
        "ones": ones_count,
        "chi_squared": chi_squared_statistic,
        "critical_value": critical_value
    }
    
    if chi_squared_statistic < critical_value:
        result["conclusion"] = "PASS (المتتالية تبدو عشوائية ضمن هذا الاختبار)"
    else:
        result["conclusion"] = "FAIL (قد يكون هناك تحيز إحصائي)"
        
    return result



def change_point_test(keystream_bytes, first_part_size):
    """
    اختبار نقطة التغير: يقسم السلسلة إلى قسمين ويقارن خصائصهما الإحصائية.
    """
    
    if len(keystream_bytes) < first_part_size * 2:
        return "Not applicable (Stream too short)"
    
    # تقسيم السلسلة
    part1 = keystream_bytes[:first_part_size]
    part2 = keystream_bytes[first_part_size:]
    
    n1 = len(part1)
    n2 = len(part2)
    
    # حساب المتوسط (Mean) لكل جزء
    mean1 = sum(part1) / n1
    mean2 = sum(part2) / n2
    
    # حساب الانحراف المعياري (Standard Deviation)
    std_dev1 = math.sqrt(sum((x - mean1)**2 for x in part1) / (n1 - 1)) if n1 > 1 else 0
    std_dev2 = math.sqrt(sum((x - mean2)**2 for x in part2) / (n2 - 1)) if n2 > 1 else 0

jana .., [14/12/2025 11:15 ص]
# استخدام إحصائية T-Test للمقارنة بين متوسطي عينتين مستقلتين
    # T = (Mean1 - Mean2) / sqrt( (SD1^2/N1) + (SD2^2/N2) )
    
    if std_dev1 == 0 or std_dev2 == 0:
        return "Not applicable (Constant variance)"
        
    t_statistic_denominator = math.sqrt((std_dev1**2 / n1) + (std_dev2**2 / n2))
    t_statistic = abs(mean1 - mean2) / t_statistic_denominator
    
   
    # القيمة الحرجة لـ Z-score عند مستوى 0.05 (لـ Two-tailed test) هي 1.96
    critical_value = 1.96 
    
    result = {
        "t_statistic": t_statistic,
        "critical_value": critical_value,
        "mean_part1": mean1,
        "mean_part2": mean2
    }
    
    if t_statistic < critical_value:
        result["conclusion"] = "PASS (لا يوجد فرق كبير في متوسطات الجزئين، لا يوجد تغير نقطي واضح)"
    else:
        result["conclusion"] = "FAIL (يوجد فرق كبير، قد يدل على نقطة تغير/ضعف)"
        
    return result
